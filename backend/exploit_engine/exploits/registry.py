from abc import ABC, abstractmethod
from dataclasses import dataclass
from typing import Optional


@dataclass
class ExploitResult:
    success: bool
    response: dict
    payload_used: str
    error: Optional[str] = None


class Exploit(ABC):
    id: str
    name: str
    category: str
    description: str
    payloads: list[str]
    
    @abstractmethod
    def execute(self, target_url: str, payload_index: int = 0) -> ExploitResult:
        pass
    
    @abstractmethod
    def check_success(self, response) -> bool:
        pass
    
    def get_payload(self, index: int = 0) -> str:
        return self.payloads[index % len(self.payloads)]
    
    def to_dict(self) -> dict:
        return {
            "id": self.id,
            "name": self.name,
            "category": self.category,
            "description": self.description,
            "payloads": self.payloads,
        }


class ExploitRegistry:
    def __init__(self):
        self._exploits: dict[str, Exploit] = {}
    
    def register(self, exploit: Exploit):
        self._exploits[exploit.id] = exploit
    
    def get(self, exploit_id: str) -> Optional[Exploit]:
        return self._exploits.get(exploit_id)
    
    def list_all(self) -> list[dict]:
        return [e.to_dict() for e in self._exploits.values()]
    
    def list_by_category(self, category: str) -> list[dict]:
        return [e.to_dict() for e in self._exploits.values() if e.category == category]
    
    def get_categories(self) -> list[str]:
        return list(set(e.category for e in self._exploits.values()))
