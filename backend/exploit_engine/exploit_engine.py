from flask import Flask, jsonify, request
from flask_cors import CORS
import requests
import docker
import logging
import atexit
from dataclasses import asdict

from exploits import registry

app = Flask(__name__)
CORS(app)
logging.basicConfig(level=logging.DEBUG)

VULN_APP_URL = "http://localhost:5001"
container = None


def setup_container():
    global container
    client = docker.from_env()
    
    for c in client.containers.list(all=True, filters={"ancestor": "vuln-app"}):
        c.stop()
        c.remove()
    
    try:
        container = client.containers.run(
            "vuln-app",
            ports={"5000/tcp": 5001},
            detach=True,
        )
        app.logger.info("vuln-app container started")
    except docker.errors.ImageNotFound:
        app.logger.error("Run 'docker build -t vuln-app .' in vuln_app/ first!")
        raise SystemExit(1)


def cleanup_container():
    global container
    if container:
        try:
            container.stop()
            container.remove()
            app.logger.info("vuln-app container stopped")
        except Exception as e:
            app.logger.error(f"Cleanup error: {e}")


atexit.register(cleanup_container)


@app.route("/exploits", methods=["GET"])
def list_exploits():
    category = request.args.get("category")
    if category:
        return jsonify(registry.list_by_category(category))
    return jsonify(registry.list_all())


@app.route("/exploits/categories", methods=["GET"])
def list_categories():
    return jsonify(registry.get_categories())


@app.route("/exploit/<exploit_id>", methods=["POST"])
def run_exploit(exploit_id: str):
    exploit = registry.get(exploit_id)
    if not exploit:
        return jsonify({"error": f"Unknown exploit: {exploit_id}"}), 404
    
    payload_index = request.json.get("payload_index", 0) if request.json else 0
    result = exploit.execute(VULN_APP_URL, payload_index)
    return jsonify(asdict(result))


@app.route("/mitigate/<vuln_type>", methods=["POST"])
def mitigate(vuln_type: str):
    try:
        resp = requests.post(f"{VULN_APP_URL}/mitigate/{vuln_type}")
        return jsonify(resp.json())
    except requests.RequestException as e:
        return jsonify({"error": str(e)}), 500


@app.route("/mitigate", methods=["POST"])
def mitigate_all():
    try:
        resp = requests.post(f"{VULN_APP_URL}/mitigate")
        return jsonify(resp.json())
    except requests.RequestException as e:
        return jsonify({"error": str(e)}), 500


@app.route("/reset", methods=["POST"])
def reset():
    try:
        resp = requests.post(f"{VULN_APP_URL}/reset")
        return jsonify(resp.json())
    except requests.RequestException as e:
        return jsonify({"error": str(e)}), 500


@app.route("/status", methods=["GET"])
def status():
    try:
        resp = requests.get(f"{VULN_APP_URL}/status")
        return jsonify(resp.json())
    except requests.RequestException as e:
        return jsonify({"error": str(e), "vuln_app": "unreachable"}), 500


# Legacy endpoints for backwards compatibility
@app.route("/exploit", methods=["GET"])
def legacy_xss():
    result = registry.get("xss_reflected").execute(VULN_APP_URL)
    return jsonify({"success": result.success, "response": result.response.get("html", "")})


@app.route("/exploit_sqli", methods=["GET"])
def legacy_sqli():
    result = registry.get("sqli_login").execute(VULN_APP_URL)
    return jsonify({"success": result.success, "response": result.response})


@app.route("/exploit_csrf", methods=["GET"])
def legacy_csrf():
    result = registry.get("csrf_transfer").execute(VULN_APP_URL)
    return jsonify({"success": result.success, "response": result.response})


@app.route("/exploit_lfi", methods=["GET"])
def legacy_lfi():
    result = registry.get("lfi_path_traversal").execute(VULN_APP_URL)
    return jsonify({"success": result.success, "response": result.response})


if __name__ == "__main__":
    setup_container()
    app.run(host="0.0.0.0", port=5000)
